require 'open-uri'
Prospectus.extra_dep('file', 'nokogiri')
Prospectus.extra_dep('file', 'prospectus_circleci')

my_slug = 'akerl/roller'

def upstream_version
  page = Nokogiri::HTML(open('https://www.python.org/downloads/source/'))
  table = page.xpath('//*[@id="content"]/div/section/article/ul[1]')
  table.text.split("\n").grep(/Latest/).map(&:split).map(&:last).join(' ')
end

UPSTREAM_VERSION = upstream_version

item do
  noop

  deps do
    item do
      name 'gems'

      expected do
        static
        set 'green'
      end

      actual do
        gemnasium
        slug my_slug
      end
    end

    item do
      name 'python'

      expected do
        static
        set UPSTREAM_VERSION
      end

      actual do
        static
        set File.readlines('circle.yml').grep(/PYENV_VER/).first.split(': ').last.chomp
      end
    end
  end

  extend ProspectusCircleci::Build.new(my_slug)
end
